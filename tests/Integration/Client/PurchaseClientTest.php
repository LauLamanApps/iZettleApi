<?php

declare(strict_types=1);

namespace LauLamanApps\IzettleApi\Tests\Integration\Client;

use DateTime;
use LauLamanApps\IzettleApi\API\Purchase\AbstractPayment;
use LauLamanApps\IzettleApi\API\Purchase\Payment\CardPayment;
use LauLamanApps\IzettleApi\API\Purchase\Payment\CashPayment;
use LauLamanApps\IzettleApi\API\Purchase\Product;
use LauLamanApps\IzettleApi\API\Purchase\Purchase;
use LauLamanApps\IzettleApi\API\Purchase\PurchaseHistory;
use LauLamanApps\IzettleApi\IzettleClientFactory;
use Ramsey\Uuid\Uuid;

/**
 * @medium
 */
final class PurchaseClientTest extends AbstractClientTest
{
    /**
     * @test
     */
    public function getPurchaseHistory(): void
    {
        $json = file_get_contents(dirname(__FILE__) . '/files/PurchaseClient/getPurchaseHistory.json');
        $data = json_decode($json, true);
        $iZettleClient = $this->getGuzzleIzettleClient(200, $json);
        $purchaseClient = IzettleClientFactory::getPurchaseClient($iZettleClient);

        $purchaseHistory = $purchaseClient->getPurchaseHistory();

        self::assertInstanceOf(PurchaseHistory::class, $purchaseHistory);

        $index = 0;
        foreach ($purchaseHistory->getPurchases() as $purchase) {
            $this->assertPurchase($purchase, $data['purchases'][$index]);
            $index++;
        }
    }

    /**
     * @test
     */
    public function getPurchase(): void
    {
        $json = file_get_contents(dirname(__FILE__) . '/files/PurchaseClient/getPurchase.json');
        $data = json_decode($json, true);
        $iZettleClient = $this->getGuzzleIzettleClient(200, $json);
        $purchaseClient = IzettleClientFactory::getPurchaseClient($iZettleClient);

        $purchase = $purchaseClient->getPurchase(Uuid::uuid1());

        $this->assertPurchase($purchase, $data);
    }

    /**
     * @test
     * @expectedException \LauLamanApps\IzettleApi\Client\Purchase\Exception\PurchaseNotFoundException
     */
    public function getPurchase_404ShouldThrowException(): void
    {
        $iZettleClient = $this->getGuzzleIzettleClient(404, '{"developerMessage":"XXX not found","errorType":null,"violations":[]}');
        $purchaseClient = IzettleClientFactory::getPurchaseClient($iZettleClient);

        $purchaseClient->getPurchase(Uuid::uuid1());
    }

    private function assertPurchase(Purchase $purchase, $data): void
    {
        self::assertSame($data['purchaseUUID'], $purchase->getUuid());
        self::assertSame($data['purchaseUUID1'], (string) $purchase->getUuid1());
        self::assertSame($data["amount"], (int) $purchase->getAmount()->getAmount());
        self::assertSame($data["vatAmount"], (int) $purchase->getVatAmount()->getAmount());
        self::assertSame($data["country"], $purchase->getCountry());
        self::assertSame($data["currency"], $purchase->getAmount()->getCurrency()->getCode());
        self::assertEquals(new DateTime($data["timestamp"]), $purchase->getTimestamp());
        self::assertSame($data["gpsCoordinates"]['latitude'], $purchase->getCoordinates()->getLatitude());
        self::assertSame($data["gpsCoordinates"]['longitude'], $purchase->getCoordinates()->getLongitude());
        self::assertSame((float) $data["gpsCoordinates"]['accuracyMeters'], $purchase->getCoordinates()->getAccuracyMeters());
        self::assertSame($data["purchaseNumber"], $purchase->getPurchaseNumber());
        self::assertSame($data["userDisplayName"], $purchase->getUser()->getDisplayName());
        self::assertSame($data["userId"], $purchase->getUser()->getId());
        self::assertSame($data["organizationId"], $purchase->getOrganizationId());

        /** @var Product $product */
        foreach ($purchase->getProducts() as $index => $product) {
            self::assertInstanceOf(Product::class, $product);
            self::assertSame($data["products"][$index]['quantity'], (string)$product->getQuantity());
            self::assertSame($data["products"][$index]['unitPrice'], (int) $product->getUnitPrice()->getAmount());
            self::assertSame($data["products"][$index]['rowTaxableAmount'], (int) $product->getRowTaxableAmount()->getAmount());
            self::assertSame($data["products"][$index]['name'], $product->getName());
            self::assertSame($data["products"][$index]['variantName'], $product->getVariantName());
            self::assertSame($data["products"][$index]['autoGenerated'], $product->isAutoGenerated());
            self::assertSame($data["products"][$index]['libraryProduct'], $product->isLibraryProduct());
            if ($product->getVat()) {
                self::assertSame((float) $data["products"][$index]['vatPercentage'], (float) $product->getVat()->getPercentage());
            } else {
                self::assertSame((int) $data["products"][$index]['vatPercentage'], 0);
            }
        }

        /** @var AbstractPayment $payment */
        foreach ($purchase->getPayments() as $index => $payment) {
            self::assertInstanceOf(AbstractPayment::class, $payment);
            self::assertSame($data["payments"][$index]['uuid'], (string) $payment->getUuid());
            self::assertSame($data["payments"][$index]['amount'], (int) $payment->getAmount()->getAmount());
            if ($payment instanceof CashPayment) {
                self::assertSame($data['payments'][$index]['attributes']['handedAmount'], (int) $payment->getHandedAmount()->getAmount());
            }
            if ($payment instanceof CardPayment) {
                self::assertSame($data['payments'][$index]['attributes']['cardPaymentEntryMode'], $payment->getCardPaymentEntryMode());
                self::assertSame($data['payments'][$index]['attributes']['maskedPan'], $payment->getMaskedPan());
                self::assertSame($data['payments'][$index]['attributes']['referenceNumber'], $payment->getReferenceNumber());
                self::assertSame($data['payments'][$index]['attributes']['nrOfInstallments'], $payment->getNrOfInstallments());
                self::assertSame($data['payments'][$index]['attributes']['cardType'], $payment->getCardType());
                self::assertSame($data['payments'][$index]['attributes']['terminalVerificationResults'], $payment->getTerminalVerificationResults());
                if (array_key_exists('applicationIdentifier', $data['payments'][$index]['attributes'])) {
                    self::assertSame($data['payments'][$index]['attributes']['applicationIdentifier'], $payment->getApplicationIdentifier());
                }
                if (array_key_exists('applicationName', $data['payments'][$index]['attributes'])) {
                    self::assertSame($data['payments'][$index]['attributes']['applicationName'], $payment->getApplicationName());
                }
            }
        }

        self::assertSame($data["receiptCopyAllowed"], $purchase->isReceiptCopyAllowed());
        self::assertSame($data["published"], $purchase->getPublished());

        foreach ($purchase->getPayments() as $index => $payment) {
            self::assertInstanceOf(AbstractPayment::class, $payment);
            self::assertSame($data["payments"][$index]['uuid'], (string) $payment->getUuid());
            self::assertSame($data["payments"][$index]['amount'], (int) $payment->getAmount()->getAmount());
        }

        self::assertSame($data["refund"], $purchase->isRefund());
        self::assertSame($data["refunded"], $purchase->isRefunded());
    }
}
